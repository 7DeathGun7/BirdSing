@model BirdSing.Models.GrupoMateria
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Asignar Materia a Grupo";
}

<h2>@ViewData["Title"]</h2>

<form asp-action="RegistroGrupoMateria" method="post" class="mt-4">
    @Html.AntiForgeryToken()
   
    @* Sólo mostramos el resumen de errores si el ModelState NO es válido *@
    @if (!ViewData.ModelState.IsValid)
    {
        <div asp-validation-summary="All" class="alert alert-danger"></div>
    }

    <div class="mb-3">
        <label asp-for="IdGrupo" class="form-label">Grado–Grupo</label>
        <select asp-for="IdGrupo" asp-items="ViewBag.Grupos" class="form-select" id="grupoSelect"></select>
        <span asp-validation-for="IdGrupo" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="IdMateria" class="form-label">Materia</label>
        <select asp-for="IdMateria" class="form-select" id="materiaSelect"></select>
        <span asp-validation-for="IdMateria" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-success">Registrar</button>
    <a asp-action="ListaGrupoMaterias" class="btn btn-secondary ms-2">Cancelar</a>
</form>
<script>
    document.getElementById("grupoSelect").addEventListener("change", function () {
        const grupoId = this.value;

        fetch(`/GrupoMaterias/ObtenerGradoPorGrupo?grupoId=${grupoId}`)
            .then(res => res.json())
            .then(data => {
                const gradoId = data.gradoId;

                return fetch(`/GrupoMaterias/ObtenerMateriasPorGrado?gradoId=${gradoId}`);
            })
            .then(res => res.json())
            .then(materias => {
                const materiaSelect = document.getElementById("materiaSelect");
                materiaSelect.innerHTML = "";

                console.log("Materias recibidas:", materias);

                materias.forEach(m => {
                    const option = document.createElement("option");
                    option.value = m.value;
                    option.text = m.text;
                    materiaSelect.appendChild(option);
                });
            });
    });

    // ✅ Cargar materias automáticamente al cargar la página
    window.addEventListener("DOMContentLoaded", function () {
        const grupoSelect = document.getElementById("grupoSelect");
        const evento = new Event("change");
        grupoSelect.dispatchEvent(evento);
    });
</script>

